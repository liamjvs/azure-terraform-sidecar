pool:
  vmImage: ubuntu-latest

parameters:
  - name: service_connection
    type: string
    displayName: Service Connection To Use
  - name: ado_service_connection
    type: string
    default: ''
    displayName: (Optional) ADO Service Connection To Use
  - name: ado_agent_pool_vmss_id
    type: string
    displayName: Azure VMSS ID
  - name: ado_service_connection_name
    type: string
    displayName: New ADO Service Connection Name
  - name: ado_agent_pool_name
    type: string
    displayName: New ADO Agent Pool Name
  - name: subscription_name
    type: string
    displayName: Subscription Name (for new ADO Service Connection)
  - name: skip_checks
    type: boolean
    default: false
    displayName: Skip ADO Checks?

stages:
- stage: check_ado
  displayName: Check ADO
  jobs:
  - job: tf_init
    displayName: terraform plan
    steps:
      - template: templates/utils/cloud_init.yaml
      - checkout: self
        persistCredentials: true
      - template: templates/utils/remove_backend.yaml
      - template: templates/az/login.yaml
        parameters:
          service_connection: ${{ parameters.service_connection }}
          managed_identity: false
      - template: templates/tf/init.yaml
        parameters:
          azure_subscription_id: ${{ parameters.subscription_name }}
          working_directory: '$(Build.SourcesDirectory)/terraform'

      