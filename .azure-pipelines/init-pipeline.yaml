pool:
  vmImage: ubuntu-latest

parameters:
  - name: service_connection
    type: string
    displayName: Service Connection To Use
  - name: ado_service_connection
    type: string
    default: ''
    displayName: (Optional) ADO Service Connection To Use
  - name: ado_agent_pool_vmss_id
    type: string
    displayName: Azure VMSS ID
  - name: ado_service_connection_name
    type: string
    displayName: New ADO Service Connection Name
  - name: ado_agent_pool_name
    type: string
    displayName: New ADO Agent Pool Name
  - name: subscription_name
    type: string
    displayName: Subscription Name (for new ADO Service Connection)
  - name: skip_checks
    type: boolean
    default: false
    displayName: Skip ADO Checks?

stages:
- stage: check_ado
  displayName: Check ADO
  jobs:
  - job: check_ado
    displayName: Check ADO
    steps:
      - template: templates/ado/check_ado.yaml
        parameters:
          service_connection: ${{ coalesce(parameters.ado_service_connection, parameters.service_connection) }}
          skip: ${{ parameters.skip_checks }}
          ado_org: $(System.TeamFoundationCollectionUri)
          ado_project: $(System.TeamProject)
      - template: templates/ado/register_agent.yaml
        parameters:
          ado_service_connection: ${{ parameters.ado_service_connection }}
          ado_service_connection_name: ${{ parameters.ado_service_connection_name }}
          ado_agent_pool_name: ${{ parameters.ado_agent_pool_name }}
          ado_agent_pool_vmss_id: ${{ parameters.ado_agent_pool_vmss_id }}
          service_connection: ${{ parameters.service_connection }}
          subscription_name: ${{ parameters.subscription_name }}
          ado_org: $(System.TeamFoundationCollectionUri)
          ado_project: $(System.TeamProject)
  - job: tf_init
    displayName: terraform init
    steps:
      - template: templates/utils/cloud_init.yaml
      - checkout: self
        persistCredentials: true
      - template: templates/utils/remove_backend.yaml
      - template: 

      